@model IEnumerable<AuthTest_RoleBased.Models.Order>

@using Microsoft.AspNetCore.Identity
@inject UserManager<AuthTest_RoleBased.Data.ApplicationUser> UserManager
@inject SignInManager<AuthTest_RoleBased.Data.ApplicationUser> SignInManager

@{
    ViewData["Title"] = $"Orders for {ViewBag.UserName}";
}

<div class="container mt-4">
    <h2 class="mb-4 text-primary"><i class="bi bi-bag-check-fill"></i> @ViewData["Title"]</h2>

    @if (!Model.Any())
    {
        <div class="alert alert-info shadow-sm">
            <i class="bi bi-info-circle"></i> No orders found for this user.
        </div>
    }
    else
    {
        <div class="table-responsive shadow-sm rounded">
            <table class="table table-hover table-bordered align-middle table-striped">
                <thead class="table-dark text-center">
                    <tr>
                        <th scope="col"><i class="bi bi-hash"></i> Order ID</th>
                        <th scope="col"><i class="bi bi-calendar-event"></i> Date</th>
                        <th>Address</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Items</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody class="text-center">
                    @foreach (var order in Model)
                    {
                        <tr>
                            <td>@order.OrderId</td>
                            <td>@order.OrderDate.ToString("dd MMM yyyy")</td>
                            <td>@order.User.Country</td>
                            <td>@order.User.CellPhone</td>
                            <td>
                                @if (User.IsInRole("ADMIN") || User.IsInRole("MANAGER"))
                                {
                                    <form asp-action="UpdateOrderStatus" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@order.OrderId" />
                                        <select name="status" class="form-select form-select-sm" onchange="this.form.submit()" title="Change order status">
                                            <option value="Pending" selected="@("Pending" == order.Status)">Pending</option>
                                            <option value="Shipped" selected="@("Shipped" == order.Status)">Shipped</option>
                                            <option value="Delivered" selected="@("Delivered" == order.Status)">Delivered</option>
                                            <option value="Cancelled" selected="@("Cancelled" == order.Status)">Cancelled</option>
                                        </select>
                                    </form>
                                }
                                else
                                {
                                    <span class="badge rounded-pill
                                                    @(order.Status == "Pending" ? "bg-warning text-dark" :
                                                                                    order.Status == "Shipped" ? "bg-primary text-light" :
                                                                                    order.Status == "Delivered" ? "bg-success text-light" :
                                                                                    order.Status == "Cancelled" ? "bg-danger text-light" :
                                                                                    "bg-secondary")">
                            @order.Status
                        </span>
                                                }
                            </td>
                            <td class="text-start">
                                <ul class="mb-0 ps-3">
                                    @foreach (var item in order.OrderItems)
                                    {
                                        <li>
                                            <strong>@item.Product.Name</strong><br />
                                            Qty: @item.Quantity, Price: @item.Price.ToString("C")
                                        </li>
                                    }
                                </ul>
                            </td>
                            <td class="fw-bold text-end">@order.OrderItems.Sum(i => i.Quantity * i.Price).ToString("C")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    <div class="text-start mt-4">
        <a asp-controller="Role" asp-action="UserList" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left-circle"></i> Back to User List
        </a>
    </div>
</div>
