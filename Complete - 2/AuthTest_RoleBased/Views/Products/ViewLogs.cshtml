@model IEnumerable<AuthTest_RoleBased.Models.ProductLog>

@{
    ViewData["Title"] = "Product Logs";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<div class="container mt-4">
    <h2 class="text-center text-primary mb-4">
        <i class="bi bi-clock-history"></i> @ViewData["Title"]
    </h2>

    @if (!Model.Any())
    {
        <div class="alert alert-info text-center">
            <i class="bi bi-info-circle-fill"></i> No logs available.
        </div>
    }
    else
    {
        <!-- Filters -->
        <div class="row mb-3">
            <div class="col-md-4">
                <input type="text" id="logFilter" class="form-control" placeholder="🔍 Search logs..." />
            </div>
            <div class="col-md-3">
                <input type="date" id="dateFilter" class="form-control" />
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-danger w-100" onclick="clearFilters()">
                    <i class="bi bi-x-circle"></i> Clear Filters
                </button>
            </div>
            <div class="col-md-2 text-end">
                <button class="btn btn-outline-success w-100" onclick="exportTableToCSV('product_logs.csv')">
                    <i class="bi bi-download"></i> Export CSV
                </button>
            </div>
        </div>

        <!-- Table -->
        <div class="table-responsive shadow-sm rounded">
            <table id="logsTable" class="table table-bordered table-striped table-hover align-middle">
                <thead class="table-dark text-center">
                    <tr>
                        <th>Action</th>
                        <th>User</th>
                        <th>Details</th>
                        <th>Action Date</th>
                    </tr>
                </thead>
                <tbody class="text-center">
                    @foreach (var log in Model)
                    {
                        <tr data-datetime="@log.ActionDate.ToString("yyyy-MM-dd")">
                            <td>
                                <span class="badge
                                    @(log.Action == "Created" ? "bg-success" :
                                      log.Action == "Updated" ? "bg-warning text-dark" :
                                      log.Action == "Deleted" ? "bg-danger" : "bg-secondary")">
                                    @log.Action
                                </span>
                            </td>
                            <td>@log.User</td>
                            <td class="text-start">
                                @if (log.Action == "Updated")
                                {
                                    <div class="text-danger">
                                        <i class="bi bi-pencil-fill"></i> <strong>Old Details:</strong><br />
                                        @log.Details
                                    </div>
                                }
                                else
                                {
                                    <span>@log.Details</span>
                                }
                            </td>
                            <td class="action-date" data-datetime="@log.ActionDate.ToString("o")"></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination + Go to Page -->
        <nav aria-label="Page navigation" class="mt-3 d-flex justify-content-center align-items-center gap-3 flex-wrap">
            <ul id="pagination" class="pagination mb-0"></ul>

            <span id="pageInfo" class="fw-bold"></span>

            <div class="d-flex align-items-center gap-2">
                <label for="gotoPageInput" class="mb-0">Go to page:</label>
                <input type="number" id="gotoPageInput" min="1" style="width: 70px;" class="form-control form-control-sm" />
                <button id="gotoPageBtn" class="btn btn-primary btn-sm">Go</button>
            </div>
        </nav>
    }
</div>

<script>
    const allRows = Array.from(document.querySelectorAll("#logsTable tbody tr"));
    const rowsPerPage = 10;
    let currentPage = 1;

    // Format ActionDate cells in 12-hour AM/PM format on page load
    function formatActionDates() {
        document.querySelectorAll(".action-date").forEach(cell => {
            const isoDate = cell.getAttribute("data-datetime");
            if (isoDate) {
                const date = new Date(isoDate);
                const options = {
                    year: "numeric", month: "2-digit", day: "2-digit",
                    hour: "2-digit", minute: "2-digit",
                    hour12: true
                };
                cell.innerText = date.toLocaleString(undefined, options).replace(",", "");
            }
        });
    }

    // Load filters from localStorage
    document.getElementById("logFilter").value = localStorage.getItem("logFilter") || "";
    document.getElementById("dateFilter").value = localStorage.getItem("dateFilter") || "";

    function filterRows() {
        const keyword = document.getElementById("logFilter").value.toLowerCase();
        const dateValue = document.getElementById("dateFilter").value;
        return allRows.filter(row => {
            const rowDate = row.getAttribute("data-datetime"); // yyyy-MM-dd from data attribute
            const matchesText = row.innerText.toLowerCase().includes(keyword);
            const matchesDate = dateValue === "" || rowDate === dateValue;
            return matchesText && matchesDate;
        });
    }

    function createPagination(totalPages) {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        // First page button << 
        const firstLi = document.createElement("li");
        firstLi.className = "page-item" + (currentPage === 1 ? " disabled" : "");
        firstLi.innerHTML = `<a class="page-link" href="#" aria-label="First">&laquo;&laquo;</a>`;
        firstLi.addEventListener("click", e => {
            e.preventDefault();
            if (currentPage !== 1) {
                currentPage = 1;
                showPage(currentPage);
            }
        });
        pagination.appendChild(firstLi);

        // Prev button <
        const prevLi = document.createElement("li");
        prevLi.className = "page-item" + (currentPage === 1 ? " disabled" : "");
        prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous">&laquo;</a>`;
        prevLi.addEventListener("click", e => {
            e.preventDefault();
            if (currentPage > 1) {
                currentPage--;
                showPage(currentPage);
            }
        });
        pagination.appendChild(prevLi);

        // Page numbers logic (max 5 pages visible, current in middle)
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }

        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement("li");
            li.className = "page-item" + (i === currentPage ? " active" : "");
            li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
            li.addEventListener("click", e => {
                e.preventDefault();
                currentPage = i;
                showPage(currentPage);
            });
            pagination.appendChild(li);
        }

        // Next button >
        const nextLi = document.createElement("li");
        nextLi.className = "page-item" + (currentPage === totalPages ? " disabled" : "");
        nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next">&raquo;</a>`;
        nextLi.addEventListener("click", e => {
            e.preventDefault();
            if (currentPage < totalPages) {
                currentPage++;
                showPage(currentPage);
            }
        });
        pagination.appendChild(nextLi);

        // Last page button >>
        const lastLi = document.createElement("li");
        lastLi.className = "page-item" + (currentPage === totalPages ? " disabled" : "");
        lastLi.innerHTML = `<a class="page-link" href="#" aria-label="Last">&raquo;&raquo;</a>`;
        lastLi.addEventListener("click", e => {
            e.preventDefault();
            if (currentPage !== totalPages) {
                currentPage = totalPages;
                showPage(currentPage);
            }
        });
        pagination.appendChild(lastLi);
    }

    function showPage(page) {
        const filteredRows = filterRows();
        const totalPages = Math.ceil(filteredRows.length / rowsPerPage) || 1;

        if (page < 1) page = 1;
        if (page > totalPages) page = totalPages;
        currentPage = page;

        // Hide all rows
        allRows.forEach(row => row.style.display = "none");

        // Show only current page rows from filtered rows
        const start = (page - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        filteredRows.slice(start, end).forEach(row => row.style.display = "");

        // Update page info text
        document.getElementById("pageInfo").innerText =
            filteredRows.length > 0
                ? `Page ${currentPage} of ${totalPages}`
                : "No matching logs found";

        // Create pagination buttons
        createPagination(totalPages);
    }

    function refreshTableAndPagination() {
        showPage(currentPage);
    }

    // Filter event listeners with localStorage save
    document.getElementById("logFilter").addEventListener("keyup", function () {
        localStorage.setItem("logFilter", this.value);
        currentPage = 1;
        refreshTableAndPagination();
    });

    document.getElementById("dateFilter").addEventListener("change", function () {
        localStorage.setItem("dateFilter", this.value);
        currentPage = 1;
        refreshTableAndPagination();
    });

    // Clear filters function
    function clearFilters() {
        localStorage.removeItem("logFilter");
        localStorage.removeItem("dateFilter");
        document.getElementById("logFilter").value = "";
        document.getElementById("dateFilter").value = "";
        currentPage = 1;
        refreshTableAndPagination();
    }

    // Go to page button handler
    document.getElementById("gotoPageBtn").addEventListener("click", () => {
        const input = document.getElementById("gotoPageInput");
        const filtered = filterRows();
        const totalPages = Math.ceil(filtered.length / rowsPerPage) || 1;
        let pageNum = parseInt(input.value);

        if (!isNaN(pageNum) && pageNum >= 1 && pageNum <= totalPages) {
            currentPage = pageNum;
            showPage(currentPage);
            input.value = "";
        } else {
            alert(`Please enter a valid page number between 1 and ${totalPages}.`);
        }
    });

    // Initialize
    formatActionDates();
    refreshTableAndPagination();
</script>
