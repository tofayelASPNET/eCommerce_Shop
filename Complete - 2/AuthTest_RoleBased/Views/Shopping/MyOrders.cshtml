@model IEnumerable<AuthTest_RoleBased.Models.Order>

@{
    ViewData["Title"] = "My Orders";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<div class="container mt-5">
    <h2 class="mb-4 text-primary">
        <i class="bi bi-cart-check-fill"></i> @ViewData["Title"]
    </h2>

    @if (!Model.Any())
    {
        <div class="alert alert-info d-flex align-items-center">
            <i class="bi bi-info-circle-fill me-2 fs-5"></i>
            You have no orders yet.
        </div>
    }
    else
    {
        <div class="alert alert-success d-flex align-items-center shadow-sm">
            <i class="bi bi-check-circle-fill me-2 fs-4"></i>
            <div>
                <strong>ওর্ডার করার জন্য আপনাকে ধন্যবাদ!</strong><br />
                কিছুক্ষণের মধ্যে আমাদের প্রতিনিধি আপনাকে কল করবেন।
            </div>
        </div>

        <!-- Filters -->
        <div class="row mt-4 mb-3">
            <div class="col-md-4">
                <input type="text" id="orderSearch" class="form-control" placeholder="🔍 Search orders..." />
            </div>
            <div class="col-md-3">
                <input type="date" id="orderDate" class="form-control" />
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-danger w-100" onclick="clearOrderFilters()">
                    <i class="bi bi-x-circle"></i> Clear Filters
                </button>
            </div>
            <div class="col-md-2">
                <button class="btn btn-outline-success w-100" onclick="exportOrdersToCSV()">
                    <i class="bi bi-download"></i> Export CSV
                </button>
            </div>
        </div>

        <!-- Orders Table -->
        <div class="table-responsive mt-2">
            <table id="ordersTable" class="table table-bordered table-hover shadow-sm rounded align-middle">
                <thead class="table-dark text-center">
                    <tr>
                        <th>Order ID</th>
                        <th>Date</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Delivery Info</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var order in Model)
                    {
                        <tr class="text-center" data-date="@order.OrderDate.ToString("yyyy-MM-dd")">
                            <td class="fw-semibold">@order.OrderId</td>
                            <td>@order.OrderDate.ToString("dd MMM yyyy")</td>
                            <td class="text-start">
                                <ul class="list-unstyled mb-0">
                                    @foreach (var item in order.OrderItems)
                                    {
                                        <li class="mb-2 border-bottom pb-1">
                                            <i class="bi bi-bag-check-fill text-success"></i>
                                            <strong>@item.Product.Name</strong><br />
                                            Qty: <span class="badge bg-light text-dark">@item.Quantity</span>,
                                            Price: <span class="text-muted">@item.Price.ToString("C", new System.Globalization.CultureInfo("bn-BD"))</span>
                                        </li>
                                    }
                                </ul>
                            </td>
                            <td class="fw-bold text-success">
                                @order.OrderItems.Sum(i => i.Quantity * i.Price).ToString("C", new System.Globalization.CultureInfo("bn-BD"))
                            </td>
                            <td class="text-start">
                                <div><i class="bi bi-geo-alt-fill text-danger"></i> <strong>Address:</strong> @order.User.Country</div>
                                <div><i class="bi bi-telephone-fill text-primary"></i> <strong>Phone:</strong> @order.User.CellPhone</div>
                            </td>
                            <td>
                                <span class="badge rounded-pill px-3 py-2 fs-6
                                    @(order.Status == "Pending" ? "bg-warning text-dark" :
                                      order.Status == "Shipped" ? "bg-info text-dark" :
                                      order.Status == "Delivered" ? "bg-success text-white" :
                                      order.Status == "Cancelled" ? "bg-danger text-white" :
                                      "bg-secondary text-light")">
                                    @order.Status
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav aria-label="Page navigation" class="mt-4 d-flex justify-content-center align-items-center gap-3 flex-wrap">
            <ul id="pagination" class="pagination mb-0"></ul>
            <span id="pageInfo" class="fw-bold"></span>
            <div class="d-flex align-items-center gap-2">
                <label for="gotoPageInput" class="mb-0">Go to page:</label>
                <input type="number" id="gotoPageInput" min="1" style="width: 70px;" class="form-control form-control-sm" />
                <button id="gotoPageBtn" class="btn btn-primary btn-sm">Go</button>
            </div>
        </nav>
    }
</div>

<script>
    const allRows = Array.from(document.querySelectorAll("#ordersTable tbody tr"));
    const rowsPerPage = 10;
    let currentPage = 1;

    // Load filters from localStorage
    document.getElementById("orderSearch").value = localStorage.getItem("orderSearch") || "";
    document.getElementById("orderDate").value = localStorage.getItem("orderDate") || "";

    function filterRows() {
        const keyword = document.getElementById("orderSearch").value.toLowerCase();
        const dateValue = document.getElementById("orderDate").value;
        return allRows.filter(row => {
            const rowDate = row.getAttribute("data-date");
            const matchesText = row.innerText.toLowerCase().includes(keyword);
            const matchesDate = !dateValue || rowDate === dateValue;
            return matchesText && matchesDate;
        });
    }

    function createPagination(totalPages) {
        const pagination = document.getElementById("pagination");
        pagination.innerHTML = "";

        const createPageButton = (label, page, disabled = false, active = false) => {
            const li = document.createElement("li");
            li.className = "page-item" + (disabled ? " disabled" : "") + (active ? " active" : "");
            li.innerHTML = `<a class="page-link" href="#">${label}</a>`;
            li.addEventListener("click", e => {
                e.preventDefault();
                if (!disabled && page !== currentPage) {
                    currentPage = page;
                    showPage(currentPage);
                }
            });
            return li;
        };

        pagination.appendChild(createPageButton("««", 1, currentPage === 1));
        pagination.appendChild(createPageButton("«", currentPage - 1, currentPage === 1));

        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);

        for (let i = startPage; i <= endPage; i++) {
            pagination.appendChild(createPageButton(i, i, false, i === currentPage));
        }

        pagination.appendChild(createPageButton("»", currentPage + 1, currentPage === totalPages));
        pagination.appendChild(createPageButton("»»", totalPages, currentPage === totalPages));
    }

    function showPage(page) {
        const filtered = filterRows();
        const totalPages = Math.ceil(filtered.length / rowsPerPage) || 1;
        currentPage = Math.min(Math.max(1, page), totalPages);

        allRows.forEach(row => row.style.display = "none");
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;
        filtered.slice(start, end).forEach(row => row.style.display = "");

        document.getElementById("pageInfo").innerText = filtered.length
            ? `Page ${currentPage} of ${totalPages}`
            : "No matching orders found";

        createPagination(totalPages);
    }

    function refreshTableAndPagination() {
        showPage(currentPage);
    }

    document.getElementById("orderSearch").addEventListener("keyup", function () {
        localStorage.setItem("orderSearch", this.value);
        currentPage = 1;
        refreshTableAndPagination();
    });

    document.getElementById("orderDate").addEventListener("change", function () {
        localStorage.setItem("orderDate", this.value);
        currentPage = 1;
        refreshTableAndPagination();
    });

    function clearOrderFilters() {
        localStorage.removeItem("orderSearch");
        localStorage.removeItem("orderDate");
        document.getElementById("orderSearch").value = "";
        document.getElementById("orderDate").value = "";
        currentPage = 1;
        refreshTableAndPagination();
    }

    document.getElementById("gotoPageBtn").addEventListener("click", () => {
        const input = document.getElementById("gotoPageInput");
        const pageNum = parseInt(input.value);
        const totalPages = Math.ceil(filterRows().length / rowsPerPage) || 1;

        if (!isNaN(pageNum) && pageNum >= 1 && pageNum <= totalPages) {
            currentPage = pageNum;
            showPage(currentPage);
            input.value = "";
        } else {
            alert(`Please enter a valid page number between 1 and ${totalPages}.`);
        }
    });

    function exportOrdersToCSV() {
        const rows = document.querySelectorAll("#ordersTable tr");
        const csv = Array.from(rows).map(row =>
            Array.from(row.querySelectorAll("th, td"))
                .map(cell => `"${cell.innerText.trim()}"`)
                .join(",")
        ).join("\n");

        const blob = new Blob([csv], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "my_orders.csv";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Init
    refreshTableAndPagination();
</script>





@* @model IEnumerable<AuthTest_RoleBased.Models.Order>

@{
    ViewData["Title"] = "My Orders";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<div class="container mt-5">
    <h2 class="mb-4 text-primary">
        <i class="bi bi-cart-check-fill"></i> @ViewData["Title"]
    </h2>

    @if (!Model.Any())
    {
        <div class="alert alert-info d-flex align-items-center">
            <i class="bi bi-info-circle-fill me-2 fs-5"></i>
            You have no orders yet.
        </div>
    }
    else
    {
        <div class="alert alert-success d-flex align-items-center shadow-sm">
            <i class="bi bi-check-circle-fill me-2 fs-4"></i>
            <div>
                <strong>ওর্ডার করার জন্য আপনাকে ধন্যবাদ!</strong><br />
                কিছুক্ষণের মধ্যে আমাদের প্রতিনিধি আপনাকে কল করবেন।
            </div>
        </div>

        <div class="table-responsive mt-4">
            <table class="table table-bordered table-hover shadow-sm rounded align-middle">
                <thead class="table-dark text-center">
                    <tr>
                        <th><i class="bi bi-hash"></i> Order ID</th>
                        <th><i class="bi bi-calendar-date-fill"></i> Date</th>
                        <th><i class="bi bi-box-seam"></i> Items</th>
                        <th><i class="bi bi-currency-exchange"></i> Total</th>
                        <th><i class="bi bi-truck"></i> Delivery Info</th>
                        <th><i class="bi bi-hourglass-split"></i> Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var order in Model)
                    {
                        <tr class="text-center">
                            <td class="fw-semibold">@order.OrderId</td>
                            <td>@order.OrderDate.ToString("dd MMM yyyy")</td>
                            <td class="text-start">
                                <ul class="list-unstyled mb-0">
                                    @foreach (var item in order.OrderItems)
                                    {
                                        <li class="mb-2 border-bottom pb-1">
                                            <i class="bi bi-bag-check-fill text-success"></i>
                                            <strong>@item.Product.Name</strong><br />
                                            Qty: <span class="badge bg-light text-dark">@item.Quantity</span>,
                                            Price: <span class="text-muted">@item.Price.ToString("C", new System.Globalization.CultureInfo("bn-BD"))</span>
                                        </li>
                                    }
                                </ul>
                            </td>
                            <td class="fw-bold text-success">
                                @order.OrderItems.Sum(i => i.Quantity * i.Price).ToString("C", new System.Globalization.CultureInfo("bn-BD"))
                            </td>
                            <td class="text-start">
                                <div><i class="bi bi-geo-alt-fill text-danger"></i> <strong>Address:</strong> @order.User.Country</div>
                                <div><i class="bi bi-telephone-fill text-primary"></i> <strong>Phone:</strong> @order.User.CellPhone</div>
                            </td>
                            <td>
                                <span class="badge rounded-pill px-3 py-2 fs-6
                                    @(order.Status == "Pending" ? "bg-warning text-dark" :
                                      order.Status == "Shipped" ? "bg-info text-dark" :
                                      order.Status == "Delivered" ? "bg-success text-white" :
                                      order.Status == "Cancelled" ? "bg-danger text-white" :
                                      "bg-secondary text-light")">
                                    @order.Status
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div> *@




@* @model IEnumerable<AuthTest_RoleBased.Models.Order>

@{
    ViewData["Title"] = "My Orders";
}

<div class="container mt-4">
    <h2 class="mb-4"><i class="bi bi-cart-check-fill text-primary"></i> @ViewData["Title"]</h2>

    @if (!Model.Any())
    {
        <div class="alert alert-info" role="alert">
            <i class="bi bi-info-circle-fill"></i> You have no orders yet.
        </div>
    }
    else
    {
        <h3 class="alert alert-success d-flex align-items-center" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            ওর্ডার করার জন্য আপনাকে ধন্যবাদ। কিছুক্ষনের মধ্যে আমাদের প্রতিনিধি আপনাকে কল করবে।
        </h3>
        <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">Order ID</th>
                        <th scope="col">Date</th>
                        <th scope="col">Items</th>
                        <th scope="col">Total</th>
                        <th scope="col">Delivery Info</th>
                        <th scope="col">Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var order in Model)
                    {
                        <tr>
                            <td>@order.OrderId</td>
                            <td>@order.OrderDate.ToString("dd MMM yyyy")</td>
                            <td>
                                <ul class="mb-0 ps-3">
                                    @foreach (var item in order.OrderItems)
                                    {
                                        <li>
                                            <strong>@item.Product.Name</strong><br />
                                            Qty: @item.Quantity, Price: @item.Price.ToString("C", new System.Globalization.CultureInfo("bn-BD"))
                                        </li>
                                    }
                                </ul>
                            </td>
                            <td>
                                <strong class="text-success">
                                    @order.OrderItems.Sum(i => i.Quantity * i.Price).ToString("C",new System.Globalization.CultureInfo("bn-BD"))
                                </strong>
                            </td>
                            <td>
                                <div>
                                    <i class="bi bi-geo-alt-fill text-danger"></i> <strong>D.Address:</strong> @order.User.Country<br />
                                    <i class="bi bi-telephone-fill text-primary"></i> <strong>Phone:</strong> @order.User.CellPhone
                                </div>
                            </td>
                            <td>
                                <span class="badge rounded-pill
                                    @(order.Status == "Pending" ? "bg-warning text-dark" :
                                      order.Status == "Shipped" ? "bg-info text-dark" :
                                      order.Status == "Delivered" ? "bg-success text-light" :
                                      order.Status == "Cancelled" ? "bg-danger text-light" :
                                      "bg-secondary text-light")">
                                    @order.Status
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div> *@
